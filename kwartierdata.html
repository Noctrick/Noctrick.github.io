<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Kwartierdata Export (Lokale Datum/Tijd)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- SheetJS voor Excel-export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; padding: 1rem; }
    label, input, select, button { display: block; margin: 0.5rem 0; }
    input[type="text"], input[type="number"] { width: 160px; }
    button { padding: 0.5rem 1rem; }
    #status { margin-top:1rem; color: #555; font-style: italic; }
  </style>
</head>
<body>
  <h1>Kwartierdata Export</h1>

  <label>EAN(s) (kommaâ€‘gescheiden):
    <input id="ean" placeholder="871687120057248244,871687120057248245">
  </label>

  <label>Startdatum (YYYYMMDD):
    <input id="start" type="text" placeholder="20250227" pattern="\d{8}" value="20250227">
  </label>

  <label>Einddatum (YYYYMMDD):
    <input id="end"   type="text" placeholder="20250228" pattern="\d{8}" value="20250228">
  </label>

  <label>Type aansluiting:
    <select id="type">
      <option>Elektriciteit</option>
      <option>Gas</option>
    </select>
  </label>

  <label>Richting:
    <select id="direction">
      <option>Levering</option>
      <option>Teruglevering</option>
    </select>
  </label>

  <label>Testmodus (eerste N rijen, leeg voor alle data):
    <input id="limit" type="number" placeholder="5" value="5">
  </label>

  <button id="download">Download Excel</button>
  <div id="status"></div>

  <script>
    const btn    = document.getElementById('download');
    const status = document.getElementById('status');

    // Parse "YYYYMMDD" into a UTC Date at 00:00
    function parseYYYYMMDD(s) {
      const m = s.match(/^(\d{4})(\d{2})(\d{2})$/);
      return m ? new Date(Date.UTC(+m[1], +m[2] - 1, +m[3], 0, 0, 0)) : null;
    }

    btn.addEventListener('click', async () => {
      status.textContent = '';
      btn.disabled = true;

      const eans      = document.getElementById('ean').value.trim();
      const startRaw  = document.getElementById('start').value.trim();
      const endRaw    = document.getElementById('end').value.trim();
      const type      = document.getElementById('type').value;
      const direction = document.getElementById('direction').value;
      const limit     = document.getElementById('limit').value.trim();

      // Validatie
      if (!eans || !startRaw || !endRaw) {
        status.textContent = 'â— Vul EAN(s), start- en einddatum in.';
        btn.disabled = false;
        return;
      }
      const startDt = parseYYYYMMDD(startRaw);
      const endDt0  = parseYYYYMMDD(endRaw);
      if (!startDt || !endDt0) {
        status.textContent = 'â— Datums moeten in YYYYMMDD-vorm zijn.';
        btn.disabled = false;
        return;
      }

      // Eind = 00:00 van de volgende dag UTC
      const endDt = new Date(endDt0.getTime());
      endDt.setUTCDate(endDt.getUTCDate() + 1);

      const startISO = startDt.toISOString();
      const endISO   = endDt.toISOString();

      status.textContent = 'â³ Ladenâ€¦';

      try {
        // Bouw query string
        const qs = new URLSearchParams({
          ean:       eans,
          start:     startISO,
          end:       endISO,
          type,
          direction,
          limit
        });
        const endpoint = "/.netlify/functions/getReading";

        console.log("ðŸ›° Fetching", endpoint + "?" + qs);
        const res = await fetch(endpoint + "?" + qs);
        console.log("â†©ï¸ HTTP status", res.status);

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(`Server gaf ${res.status}: ${txt}`);
        }

        const data = await res.json();
        console.log("ðŸ“¦ Ontvangen rijen:", data.length);

        if (!data.length) {
          status.textContent = 'âš ï¸ Geen data gevonden.';
        } else {
          // Map naar lokaal geformatteerde datum/tijd en waarde
          const sheetData = data.map(r => ({
            Datum: new Date(r.datetime).toLocaleString('nl-NL', {
              day:   '2-digit',
              month: '2-digit',
              year:  'numeric',
              hour:  '2-digit',
              minute:'2-digit'
            }),
            Waarde: r.value
          }));

          // Bouw werkblad en stel kolombreedtes in
          const ws = XLSX.utils.json_to_sheet(sheetData);
          ws['!cols'] = [{ wch: 20 }, { wch: 12 }];

          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Kwartierdata');
          XLSX.writeFile(wb, `kwartierdata_${eans}_${startRaw}.xlsx`);

          status.textContent = 'âœ… Download gestart.';
        }

      } catch (err) {
        console.error(err);
        status.textContent = `ðŸ’¥ Fout: ${err.message}`;
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
