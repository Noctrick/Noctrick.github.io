<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kwartierdata Export</title>
  <!-- SheetJS for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 1rem;
    }
    label, select, input, button {
      display: block;
      margin: 0.5rem 0;
    }
    button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
    }
    #debug {
      white-space: pre-wrap;
      background: #f9f9f9;
      border: 1px solid #ddd;
      padding: 0.5rem;
      margin-top: 1rem;
      color: #444;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <h1>Kwartierdata Export</h1>

  <label for="ean">EAN:</label>
  <input id="ean" placeholder="871687120057248244">

  <label for="start">Start:</label>
  <input id="start" type="datetime-local">

  <label for="end">End:</label>
  <input id="end" type="datetime-local">

  <label for="type">Type aansluiting:</label>
  <select id="type">
    <option>Elektriciteit</option>
    <option>Gas</option>
  </select>

  <label for="direction">Direction:</label>
  <select id="direction">
    <option>Levering</option>
    <option>Teruglevering</option>
  </select>

  <button id="download">Download Excel</button>

  <div id="debug"></div>

  <script>
    const dbgEl = document.getElementById('debug');
    function debug(msg) {
      console.log(msg);
      dbgEl.textContent += msg + "\n";
    }

    document.getElementById('download').onclick = async () => {
      dbgEl.textContent = ''; // clear previous debug

      try {
        debug("üîç Starting download process‚Ä¶");

        const ean       = document.getElementById('ean').value.trim();
        const startVal  = document.getElementById('start').value;
        const endVal    = document.getElementById('end').value;
        const type      = document.getElementById('type').value;
        const direction = document.getElementById('direction').value;

        if (!ean || !startVal || !endVal) {
          debug("‚ùó Validation failed: missing input.");
          return alert('Vul alstublieft EAN, start- en einddatum in.');
        }
        debug(`EAN=${ean}, start="${startVal}", end="${endVal}", type=${type}, direction=${direction}`);

        const startISO = new Date(startVal).toISOString();
        const endISO   = new Date(endVal).toISOString();
        debug(`Converted to ISO: start=${startISO}, end=${endISO}`);

        const qs = new URLSearchParams({ ean, start: startISO, end: endISO, type, direction });
        const url = `/.netlify/functions/getReading?${qs}`;
        debug(`Request URL: ${url}`);

        const res = await fetch(url);
        debug(`Fetch completed with status ${res.status}`);

        if (!res.ok) {
          const txt = await res.text();
          debug(`‚ùå Server returned error: ${txt}`);
          return alert(`Fout ${res.status}: ${txt}`);
        }

        const data = await res.json();
        debug(`Received ${data.length} records`);

        if (!Array.isArray(data) || data.length === 0) {
          debug("‚ö†Ô∏è Received empty or invalid data array.");
          return alert("Geen data gevonden voor deze parameters.");
        }

        // Turn JSON into worksheet and trigger download
        debug("üõ†Ô∏è Generating Excel workbook‚Ä¶");
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Kwartierdata');
        XLSX.writeFile(wb, `kwartierdata_${ean}.xlsx`);
        debug("‚úÖ Download triggered successfully.");

      } catch (err) {
        debug(`üí• Exception caught: ${err.message}`);
        console.error(err);
        alert("Er is een fout opgetreden. Kijk de debug‚Äëlog hieronder.");
      }
    };
  </script>
</body>
</html>
